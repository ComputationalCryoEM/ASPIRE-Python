"""
This script illustrates how to preprocess experimental CryoEM images
before starting the pipeline of reconstructing 3D map.
"""

import logging
import matplotlib.pyplot as plt

from aspire.source.relion import RelionSource
from aspire.estimation.noise import WhiteNoiseEstimator

logger = logging.getLogger('aspire')

# Set input path and files and initialize other parameters
starfile_in = '/tigress/junchaox/CryoEMdata/empiar10028/shiny_2sets.star'
data_folder = '/tigress/junchaox/CryoEMdata/empiar10028/'
pixel_size = 1.34
num_imgs = 100

logger.info('This script illustrates how to preprocess experimental CryoEM images')
logger.info(f'Read in images from {starfile_in} and preprocess the images')
source = RelionSource(
    starfile_in,
    data_folder,
    pixel_size=pixel_size,
    max_rows=num_imgs
)

# number of images to extract for plotting
nimgs_ext = 1

logger.info('Obtain original images')
imgs_od = source.images(start=0, num=nimgs_ext)

logger.info('Perform phase flip to input images')
source.phase_flip()
imgs_pf = source.images(start=0, num=nimgs_ext)

max_resolution = 60
logger.info(f'Downsample resolution to {max_resolution} X {max_resolution}')
if max_resolution < source.L:
    source.downsample(max_resolution)
imgs_ds = source.images(start=0, num=nimgs_ext)

logger.info('Normalize images to noise background')
source.normalize_background()
imgs_nb = source.images(start=0, num=nimgs_ext)

logger.info('Whiten noise of images')
noise_estimator = WhiteNoiseEstimator(source)
source.whiten(noise_estimator.filter)
imgs_wt = source.images(start=0, num=nimgs_ext)

logger.info('Invert global density contrast')
source.invert_contrast()
imgs_rc = source.images(start=0, num=nimgs_ext)

# plot the first images
logger.info('plot the first images')
idm = 0
plt.subplot(2, 3, 1)
plt.imshow(imgs_od[idm], cmap='gray')
plt.colorbar(orientation='horizontal')
plt.title('original image')

plt.subplot(2, 3, 2)
plt.imshow(imgs_pf[idm], cmap='gray')
plt.colorbar(orientation='horizontal')
plt.title('phase flip')

plt.subplot(2, 3, 3)
plt.imshow(imgs_ds[idm], cmap='gray')
plt.colorbar(orientation='horizontal')
plt.title('downsample')

plt.subplot(2, 3, 4)
plt.imshow(imgs_nb[idm], cmap='gray')
plt.colorbar(orientation='horizontal')
plt.title('normalize background')

plt.subplot(2, 3, 5)
plt.imshow(imgs_wt[idm], cmap='gray')
plt.colorbar(orientation='horizontal')
plt.title('noise whitening')

plt.subplot(2, 3, 6)
plt.imshow(imgs_rc[idm], cmap='gray')
plt.colorbar(orientation='horizontal')
plt.title('invert contrast')
plt.show()
