

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Class Averaging Architecture &mdash; ASPIRE 0.14.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=9e420a66"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Modules" href="modules.html" />
    <link rel="prev" title="Getting Started - CLI" href="quickstart.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            ASPIRE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting Started - CLI</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Class Averaging Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#classavgsource">ClassAvgSource</a></li>
<li class="toctree-l2"><a class="reference internal" href="#classifiers">Classifiers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#class-selectors">Class Selectors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#local-class-selectors">Local Class Selectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="#global-class-selectors">Global Class Selectors</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#class-repulsion">Class Repulsion</a></li>
<li class="toctree-l4"><a class="reference internal" href="#image-quality-functions">Image Quality Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#weightedimagequalitymixin">WeightedImageQualityMixin</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#averagers">Averagers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#imagestacker">ImageStacker</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Galleries:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="auto_tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto_experiments/index.html">Experiments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ASPIRE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Class Averaging Architecture</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/class_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="class-averaging-architecture">
<h1>Class Averaging Architecture<a class="headerlink" href="#class-averaging-architecture" title="Link to this heading">¶</a></h1>
<p>ASPIRE now contains a broad collection of configurable and extensible
components which can be combined to create class averaging solutions
tailored to different datasets.  The architecture was designed to both
be modular and encourage experimentation.  Lower level components are
aggregated into a high level interface by <code class="docutils literal notranslate"><span class="pre">ClassAvgSource</span></code>
instances.  Starting there this document will descend into each
contributing component.</p>
<section id="classavgsource">
<h2>ClassAvgSource<a class="headerlink" href="#classavgsource" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ClassAvgSource</span></code> is the fully customizable base class which links
together components into a cohesive source to be used with other
ASPIRE components.  A power user can instantiate an instance of each
required component and assign them here for complete control.</p>
<pre  class="mermaid">
        classDiagram
    class ClassAvgSource{
        src: ImageSource
        classifier: Class2D
        class_selector: ClassSelector
        averager: Averager2D
        +images()
        }

    ClassAvgSource o-- ImageSource
    ClassAvgSource o-- Class2D
    ClassAvgSource o-- ClassSelector
    ClassAvgSource o-- Averager2D

    class ImageSource{
        +images()
    }
    class Class2D{
        +classify()
    }
    class ClassSelector{
        +select()
    }
    class Averager2D{
        +average()
    }
    </pre><hr class="docutils" />
<p>While that allows for full customization, helper classes are
provided that supply defaults as a jumping off point.  These
helper sources only require an input <code class="docutils literal notranslate"><span class="pre">Source</span></code> to be instantiated.
They can still be fully customized, but they are intended to start
with sensible defaults, so users only need to instantiate the specific
components they wish to configure.</p>
<pre  class="mermaid">
        classDiagram
   ClassAvgSource &lt;|-- DebugClassAvgSource
   ClassAvgSource &lt;|-- DefaultClassAvgSource
   ClassAvgSource &lt;|-- LegacyClassAvgSource
   class DebugClassAvgSource{
      src: ImageSource
      classifier: RIRClass2D
      class_selector: TopClassSelector
      averager: BFRAverager2D
      +images()
   }
   class LegacyClassAvgSource{
      src: ImageSource
      classifier: RIRClass2D
      class_selector: GlobalVarianceClassSelector
      averager: BFRAverager2D
      +images()
   }
   class DefaultClassAvgSource{
      version=&quot;0.13.2&quot;
      src: ImageSource
      classifier: RIRClass2D
      class_selector: NeighborVarianceWithRepulsionClassSelector
      quality_function: BandedSNRImageQualityFunction
      averager: BFSRAverager2D
      +images()
   }
    </pre><p><code class="docutils literal notranslate"><span class="pre">DebugClassAvgSource</span></code> is designed for use in testing, documentation,
and development because it defaults to the simplest components while
also maintaining the original input source index ordering.  That is,
the first 10 class averages from <code class="docutils literal notranslate"><span class="pre">DebugClassAvgSource</span></code> should
correspond with the first 10 source images without requiring any index
mappings etc.</p>
<p><code class="docutils literal notranslate"><span class="pre">DefaultClassAvgSource</span></code> applies the most sensible defaults available
in the current ASPIRE release.  <code class="docutils literal notranslate"><span class="pre">DefaultClassAvgSource</span></code> takes a
version string, such as <code class="docutils literal notranslate"><span class="pre">0.13.2</span></code> which will return a specific
configuration.  This version should allow users to perform a similar
experiment across releases as ASPIRE implements improved methods.
When a version is not provided, <code class="docutils literal notranslate"><span class="pre">DefaultClassAvgSource</span></code> defaults to
the latest version available.</p>
</section>
<section id="classifiers">
<h2>Classifiers<a class="headerlink" href="#classifiers" title="Link to this heading">¶</a></h2>
<p>Classifiers take an image <code class="docutils literal notranslate"><span class="pre">Source</span></code> and attempts to classify into
<code class="docutils literal notranslate"><span class="pre">class_indices</span></code> that identify images with similar viewing angles up
to reflection.  All <code class="docutils literal notranslate"><span class="pre">Class2D</span></code> instances are expected to implement a
<code class="docutils literal notranslate"><span class="pre">classify</span></code> method which returns <code class="docutils literal notranslate"><span class="pre">(class_indices,</span> <span class="pre">class_refl,</span>
<span class="pre">class_distances)</span></code>.  The three returned variables are expected to be
2D Numpy arrays in a neighbor network format having shape
<code class="docutils literal notranslate"><span class="pre">(src.n,</span> <span class="pre">n_nbors)</span></code>.  So to retrieve the set of input source indices
for the first class’s neighbors, we would want <code class="docutils literal notranslate"><span class="pre">class_indices[0,:]</span></code>.
The first index <code class="docutils literal notranslate"><span class="pre">class_indices[0,0]</span></code> in the set is the index of the
reference image used for classification.  In this case
<code class="docutils literal notranslate"><span class="pre">class_indices[0,0]=0</span></code>. The actual underlying image would be
<code class="docutils literal notranslate"><span class="pre">input_src.images[0]</span></code>, or more generally
<code class="docutils literal notranslate"><span class="pre">input_src.images[class_indices[c,0]]</span></code> for some class <code class="docutils literal notranslate"><span class="pre">c</span></code>.</p>
<p>No further class selection or ordering occurs during classification.
Those methods are broken out into other components.</p>
<p>Currently ASPIRE has a single classification algorithm known as
<code class="docutils literal notranslate"><span class="pre">RIRClass2D</span></code>.  This algorithm uses multiple applications of PCA in
conjunction with bispectrum analysis to identify nearest neighbors in
a rotationally invariant feature space.</p>
<pre  class="mermaid">
        classDiagram
   class Class2D{
       +classify()
   }
 Class2D &lt;|-- RIRClass2D
    </pre></section>
<section id="class-selectors">
<h2>Class Selectors<a class="headerlink" href="#class-selectors" title="Link to this heading">¶</a></h2>
<p>Class Selectors consume the output of <code class="docutils literal notranslate"><span class="pre">Class2D</span></code> and attempt to order
and/or filter classes down to a selection.  Selecting the “best”
classes in cryo-EM problems is still an area of active research.  Some
common methods are provided, along with an extensible base interface.</p>
<p>Generally, Class Selection comes in two flavors depending on what
information is required to perform the selection.</p>
<section id="local-class-selectors">
<h3>Local Class Selectors<a class="headerlink" href="#local-class-selectors" title="Link to this heading">¶</a></h3>
<p>For “Local” class selection, we will attempt to use only the
information returned from <code class="docutils literal notranslate"><span class="pre">Class2D</span></code>.  In the case of <code class="docutils literal notranslate"><span class="pre">RIRClass2D</span></code>
this would primarily be a network of <code class="docutils literal notranslate"><span class="pre">distances</span></code> as measured in the
compressed feature space.</p>
<p>This approach has two main advantages.  First, we already have this
information computed as part of classification.  Second, it allows us
to register and stack a relatively small subset of the “best” classes.
Because registration and alignment are computationally expensive this
can reduce pipeline run times by an order of magnitude.</p>
<pre  class="mermaid">
        classDiagram
   class ClassSelector{
      +select()
      }
    ClassSelector &lt;|-- TopClassSelector
    ClassSelector &lt;|-- RandomClassSelector
    ClassSelector &lt;|-- NeighborVarianceClassSelector
    ClassSelector &lt;|-- GlobalVarianceClassSelector
    ClassSelector &lt;|-- DistanceClassSelector
    ClassSelector o-- GreedyClassRepulsionMixin
    </pre></section>
<section id="global-class-selectors">
<h3>Global Class Selectors<a class="headerlink" href="#global-class-selectors" title="Link to this heading">¶</a></h3>
<p>Global Class Selection techniques first compute the entire collection
of registered and aligned class averages, then compute some quality
measure on all classes.</p>
<p>Many classic experiments computed variance of each class averaged
image, sorting to express highest variance.  Sometimes this is
referred to as contrast.  Often times the classes were selected to
avoid classes with views already seen.  This can be accomplished now
by using the <code class="docutils literal notranslate"><span class="pre">VarianceImageQualityFunction</span></code> in a
<code class="docutils literal notranslate"><span class="pre">GlobalWithRepulsionClassSelector</span></code>.</p>
<p>An SNR based approach is also provided, and a bandpass method should
be implemented in a future release.  Again, these components are fully
customizable and the base interfaces were designed with algorithm
developers in mind.</p>
<p>To implementing concrete <code class="docutils literal notranslate"><span class="pre">GlobalClassSelector</span></code> instances, leverage
the subcomponents described below.</p>
<pre  class="mermaid">
        classDiagram
    ClassSelector &lt;|-- GlobalClassSelector
    class GlobalClassSelector{
        averager: Averager2D
        function: ImageQuaityFunction
        heap_size: int
        }
    GlobalClassSelector *-- ImageQualityFunction
    GlobalClassSelector ..&gt; Heap
    GlobalClassSelector &lt;|-- GlobalWithRepulsionClassSelector


    class ImageQualityFunction{
       -_function
       +__call__()
       }
    ImageQualityFunction o-- WeightedImageQualityMixin
    ImageQualityFunction &lt;|-- BandedSNRImageQualityFunction
    ImageQualityFunction &lt;|-- VarianceImageQualityFunction
    ImageQualityFunction &lt;|-- BandpassImageQualityFunction_TBD

    class WeightedImageQualityMixin{
        -_weight_function
    }
    WeightedImageQualityMixin &lt;|-- RampWeightedImageQualityMixin
    WeightedImageQualityMixin &lt;|-- BumpWeightedImageQualityMixin

    GlobalClassSelector &lt;|-- RampWeightedVarianceImageQualityFunction
    RampWeightedImageQualityMixin &lt;|-- RampWeightedVarianceImageQualityFunction
    GlobalClassSelector &lt;|-- BumpWeightedVarianceImageQualityFunction
    BumpWeightedImageQualityMixin &lt;|-- BumpWeightedVarianceImageQualityFunction
    </pre><section id="class-repulsion">
<h4>Class Repulsion<a class="headerlink" href="#class-repulsion" title="Link to this heading">¶</a></h4>
<p>Class Repulsion are techniques used to avoid classes based on some
criterion.  Currently we provide <code class="docutils literal notranslate"><span class="pre">GreedyClassRepulsionMixin</span></code>, but
this mix-in class can be mimicked to implement alternate schemes.</p>
<p><code class="docutils literal notranslate"><span class="pre">GreedyClassRepulsionMixin</span></code> is based on the following
intuition. Assume the selection has in fact ordered the classes so
that <em>the “best” classes occur first</em>. It follows that the “best”
expression of a viewing angle locus will be the first seen.  Now
assume <em>the classifier returns classes with closest viewing angles</em>
(up to reflections).  Then the classes formed by <em>neighbors of the
current expression are inferior</em>.  The aggressiveness of the neighbor
repulsion count is tunable.</p>
<p>In practice, <code class="docutils literal notranslate"><span class="pre">GreedyClassRepulsionMixin</span></code> is a mix-in designed to be
mixed into any other <code class="docutils literal notranslate"><span class="pre">ClassSelector</span></code>.  Note, that repulsion can (and
will) dramatically reduce the population of class averages returned.</p>
</section>
<section id="image-quality-functions">
<h4>Image Quality Functions<a class="headerlink" href="#image-quality-functions" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">ImageQualityFunction</span></code> interface provides a consistent way to
bring your own function to measure the quality of a single aligned and
registered class average.  This function should operate on a single
Image, with conversions and broadcasting being handled behind the
scenes.</p>
<p>An example would be <code class="docutils literal notranslate"><span class="pre">VarianceImageQualityFunction</span></code> which computes
and returns variance.</p>
<p>Another advantage of using the class is that it exposes and manages a
grid cache, which is handy to avoid recomputing the same grid for
every image when using spatial methods.</p>
</section>
<section id="weightedimagequalitymixin">
<h4>WeightedImageQualityMixin<a class="headerlink" href="#weightedimagequalitymixin" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">WeightedImageQualityMixin</span></code> is designed to mix with subclasses of
<code class="docutils literal notranslate"><span class="pre">ImageQualityFunction</span></code>, extending them with a weighted image mask
applied prior to the image quality function call.</p>
<p>Two concrete examples are provided
<code class="docutils literal notranslate"><span class="pre">BumpWeightedVarianceImageQualityFunction</span></code> and
<code class="docutils literal notranslate"><span class="pre">RampWeightedVarianceImageQualityFunction</span></code> which apply the
respective weight functions prior to the variance calculation.</p>
<p>Again, <code class="docutils literal notranslate"><span class="pre">WeightedImageQualityMixin</span></code> exposes and manages a grid cache,
this time for grid weights.</p>
</section>
</section>
</section>
<section id="averagers">
<h2>Averagers<a class="headerlink" href="#averagers" title="Link to this heading">¶</a></h2>
<p>Averagers consume from a <code class="docutils literal notranslate"><span class="pre">Source</span></code> and return averaged images
defined by class network arguments <code class="docutils literal notranslate"><span class="pre">class_indices</span></code> and <code class="docutils literal notranslate"><span class="pre">class_refl</span></code>.
You may find the terms averaging and stacking used interchangeably in
this context, so know that averaging does not always imply <em>arithmetic
mean</em>.</p>
<p>Some averaging techniques, those subclassing <code class="docutils literal notranslate"><span class="pre">AligningAverager2D</span></code>
have distinct <code class="docutils literal notranslate"><span class="pre">alignment</span></code> and <code class="docutils literal notranslate"><span class="pre">averaging</span></code> stages.  Others such as
expectation-maximization (EM) may perform these internally and provide only
an opaque <code class="docutils literal notranslate"><span class="pre">averages</span></code> stage.</p>
<pre  class="mermaid">
        classDiagram
     class Averager2D{
         basis: Basis
         src: ImageSource
         +average()
     }
     Averager2D ..&gt; ImageStacker
     Averager2D &lt;|-- AligningAverager2D
     class AligningAverager2D{
         align()
     }
     ImageSource *-- Averager2D
     Averager2D &lt;|-- AligningAverager2D
     Averager2D &lt;|-- EMAverager2D_TBD
     Averager2D &lt;|-- FTKAverager2D_TBD
     AligningAverager2D &lt;|-- BFRAverager2D
     BFRAverager2D &lt;|-- BFSRAverager2D
     AligningAverager2D &lt;|-- ReddyChetterjiAverager2D
     ReddyChetterjiAverager2D &lt;|-- BFSReddyChetterjiAverager2D
    </pre><p>Each <code class="docutils literal notranslate"><span class="pre">AligningAverager2D</span></code> can be configured to use a custom
<code class="docutils literal notranslate"><span class="pre">ImageStacker</span></code> if desired.</p>
<section id="imagestacker">
<h3>ImageStacker<a class="headerlink" href="#imagestacker" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ImageStacker</span></code> provides an interface for the common task of stacking
images.  Implementations for common stacking methods are provided and
should work for both <code class="docutils literal notranslate"><span class="pre">Image</span></code> and (1D) coefficient stacks.  Users
experimenting with advanced stacking are responsible for selecting an
ImageStacker method appropriate for their data.</p>
<p>Note that the ASPIRE default is naturally <code class="docutils literal notranslate"><span class="pre">MeanImageStacker</span></code>.</p>
<pre  class="mermaid">
        classDiagram
     class ImageStacker{
         stack()
     }
     class SigmaRejectionImageStacker{
         sigma
     }
     class WinsorizedImageStacker{
         percentile
     }
     ImageStacker &lt;|-- MeanImageStacker
     ImageStacker &lt;|-- MedianImageStacker
     ImageStacker &lt;|-- SigmaRejectionImageStacker
     SigmaRejectionImageStacker .. Gaussian
     SigmaRejectionImageStacker .. FWHM
     ImageStacker &lt;|-- WinsorizedImageStacker
    </pre></section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quickstart.html" class="btn btn-neutral float-left" title="Getting Started - CLI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="modules.html" class="btn btn-neutral float-right" title="Modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Princeton University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>