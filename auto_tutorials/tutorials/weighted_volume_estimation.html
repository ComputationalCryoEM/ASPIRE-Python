

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weighted Volume Reconstruction &mdash; ASPIRE 0.14.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=9e420a66"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Experiments" href="../../auto_experiments/index.html" />
    <link rel="prev" title="Starfile" href="starfile.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ASPIRE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Getting Started - CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class_source.html">Class Averaging Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Galleries:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#api-introduction">API Introduction</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#component-examples">Component Examples</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Component Examples</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="cov2d_simulation.html">2D Covariance Estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="orient3d_simulation.html">3D Image Orientation</a></li>
<li class="toctree-l4"><a class="reference internal" href="image_class.html">ASPIRE Image Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="apple_picker.html">Apple Picker</a></li>
<li class="toctree-l4"><a class="reference internal" href="basic_image_array.html">Basic Image Array</a></li>
<li class="toctree-l4"><a class="reference internal" href="ctf.html">CTF: Contrast Transfer Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="class_averaging.html">Class Averaging</a></li>
<li class="toctree-l4"><a class="reference internal" href="cov3d_simulation.html">Covariance 3D Estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="data_downloader.html">Data Downloader</a></li>
<li class="toctree-l4"><a class="reference internal" href="generating_volume_projections.html">Generating 3D Volume Projections</a></li>
<li class="toctree-l4"><a class="reference internal" href="image_expansion.html">Image Expansion</a></li>
<li class="toctree-l4"><a class="reference internal" href="preprocess_imgs_sim.html">Image Preprocessing</a></li>
<li class="toctree-l4"><a class="reference internal" href="micrograph_source.html">Micrograph Sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="relion_projection_interop.html">Relion Projection Interoperability</a></li>
<li class="toctree-l4"><a class="reference internal" href="starfile.html">Starfile</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Weighted Volume Reconstruction</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_experiments/index.html">Experiments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ASPIRE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Tutorials</a></li>
          <li class="breadcrumb-item"><a href="index.html">Component Examples</a></li>
      <li class="breadcrumb-item active">Weighted Volume Reconstruction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/auto_tutorials/tutorials/weighted_volume_estimation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-tutorials-tutorials-weighted-volume-estimation-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="weighted-volume-reconstruction">
<span id="sphx-glr-auto-tutorials-tutorials-weighted-volume-estimation-py"></span><h1>Weighted Volume Reconstruction<a class="headerlink" href="#weighted-volume-reconstruction" title="Link to this heading">¶</a></h1>
<p>This tutorial demonstrates a weighted volume reconstruction,
using a published reference dataset.</p>
<section id="download-an-example-dataset">
<h2>Download an Example Dataset<a class="headerlink" href="#download-an-example-dataset" title="Link to this heading">¶</a></h2>
<p>ASPIRE’s downloader will download, cache,
and unpack the reference dataset.
More information about the dataset can be found on
<a class="reference external" href="https://zenodo.org/records/8186548">Zenodo</a>
and in this <a class="reference external" href="https://iopscience.iop.org/article/10.1088/1361-6420/ab4f55/ampdf">paper</a></p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">aspire</span><span class="w"> </span><span class="kn">import</span> <span class="n">downloader</span>

<span class="n">sim_data</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">simulated_channelspin</span><span class="p">()</span>

<span class="c1"># This data contains a `Volume` stack, an `Image` stack, weights and</span>
<span class="c1"># corresponding parameters that were used to derive images</span>
<span class="c1"># from the volumes.  For example, the rotations below are the known</span>
<span class="c1"># true simulation projection rotations. In practice these would be</span>
<span class="c1"># derived from an orientation estimation component.</span>

<span class="n">imgs</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">]</span>  <span class="c1"># Simulated image stack (`Image` object)</span>
<span class="n">rots</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;rots&quot;</span><span class="p">]</span>  <span class="c1"># True projection rotations (`Rotation` object)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span>  <span class="c1"># Volume weights (`Numpy` array)</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;vols&quot;</span><span class="p">]</span>  <span class="c1"># True reference volumes (`Volume` object)</span>
</pre></div>
</div>
</section>
<section id="create-a-imagesource">
<h2>Create a <code class="docutils literal notranslate"><span class="pre">ImageSource</span></code><a class="headerlink" href="#create-a-imagesource" title="Link to this heading">¶</a></h2>
<p>The image stack and projection rotation (Euler) angles can be
associated together during instantiation of an <code class="docutils literal notranslate"><span class="pre">ImageSource</span></code>.
Because this example starts with a dense array of images,
an <code class="docutils literal notranslate"><span class="pre">ArrayImageSource</span></code> is used.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">aspire.source</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrayImageSource</span>

<span class="n">src</span> <span class="o">=</span> <span class="n">ArrayImageSource</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">rots</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>

<span class="c1"># The images are downsampled for the sake of a quicker tutorial.</span>
<span class="c1"># This line can be commented out to achieve the reference size (54 pixels).</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial demonstrates bringing reference data.
It is also possible to just create a <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> or use other
<code class="docutils literal notranslate"><span class="pre">ImageSource</span></code> objects, so long as the rotations required
for backprojecting are assigned.</p>
</div>
</section>
<section id="volume-reconstruction">
<h2>Volume Reconstruction<a class="headerlink" href="#volume-reconstruction" title="Link to this heading">¶</a></h2>
<p>Performing a weighted volume reconstruction requires defining an
appropriate 3D basis and supplying an associated image to volume
weight mapping as an array.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">aspire.basis</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFBBasis3D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aspire.reconstruction</span><span class="w"> </span><span class="kn">import</span> <span class="n">WeightedVolumesEstimator</span>

<span class="c1"># Create a reasonable Basis</span>
<span class="n">basis</span> <span class="o">=</span> <span class="n">FFBBasis3D</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># Set up an estimator to perform the backprojections and volume estimation.</span>
<span class="c1"># In this case, the `weights` array comes from the reference data set,</span>
<span class="c1"># and is shaped to map images to spectral volumes.</span>
<span class="c1"># Note that we can have many more actual/reference volumes generating</span>
<span class="c1"># the image stack than spectral volumes.  In this case the input</span>
<span class="c1"># images were generated from 54 volumes, but are described by 16</span>
<span class="c1"># spectral volumes.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;`weights shape:`&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">WeightedVolumesEstimator</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">preconditioner</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

<span class="c1"># Perform the estimation, returning a `Volume` stack.</span>
<span class="n">estimated_volume</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">estimate</span><span class="p">()</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>`weights shape:` (10000, 16)
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">estimate()</span></code> method requires a fair amount of compute time,
but there should be regularly logged progress towards convergence.</p>
</div>
</section>
<section id="comparison-of-estimated-volume-with-source-volume">
<h2>Comparison of Estimated Volume with Source Volume<a class="headerlink" href="#comparison-of-estimated-volume-with-source-volume" title="Link to this heading">¶</a></h2>
<p>Generate several random projections rotations, then compare these
projections between the estimated spectral volumes and a known volume.
If <code class="docutils literal notranslate"><span class="pre">src</span></code> was downsampled above, the resulting estimated volumes
and projections will be of similar downsampled quality.</p>
<p>Note that the estimated spectral volumes are treated as <cite>Volume</cite>
objects purely for convienience and are not expected to correspond
exactly to any particular reference volume.  The spectral volumes
collectively describe motion features derived from the input data.
However, basic visual comparison is useful as a sanity check to
demonstrate that we are in fact generating spectral volumes that
appear reasonably similar to the input volumes.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">aspire.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rotation</span>

<span class="n">reference_v</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Actual volume under comparison</span>
<span class="n">spectral_v</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Estimated spectral volume</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of projections</span>

<span class="n">random_rotations</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">generate_random_rotations</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># Estimated volume projections</span>
<span class="n">estimated_volume</span><span class="p">[</span><span class="n">spectral_v</span><span class="p">]</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">random_rotations</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Source volume projections</span>
<span class="n">vols</span><span class="p">[</span><span class="n">reference_v</span><span class="p">]</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">random_rotations</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img src="../../_images/sphx_glr_weighted_volume_estimation_001.png" srcset="../../_images/sphx_glr_weighted_volume_estimation_001.png" alt="weighted volume estimation" class = "sphx-glr-multi-img"/></li>
<li><img src="../../_images/sphx_glr_weighted_volume_estimation_002.png" srcset="../../_images/sphx_glr_weighted_volume_estimation_002.png" alt="weighted volume estimation" class = "sphx-glr-multi-img"/></li>
</ul>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (6 minutes 38.189 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-tutorials-tutorials-weighted-volume-estimation-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/19284984aa6da5bbc4d8f46e99afb5bc/weighted_volume_estimation.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">weighted_volume_estimation.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c7f878a8c8d6a247aefeef9b5502ed3f/weighted_volume_estimation.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">weighted_volume_estimation.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/f36cf2bf0ddfa86460e8b1aa04fd3e3a/weighted_volume_estimation.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">weighted_volume_estimation.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="starfile.html" class="btn btn-neutral float-left" title="Starfile" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../auto_experiments/index.html" class="btn btn-neutral float-right" title="Experiments" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Princeton University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>