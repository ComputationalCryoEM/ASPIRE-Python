
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_tutorials/tutorials/class_averaging.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_tutorials_tutorials_class_averaging.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_tutorials_tutorials_class_averaging.py:


Class Averaging
===============

We demonstrate class averaging using the rotationally invariant
representation algorithm.

.. GENERATED FROM PYTHON SOURCE LINES 8-18

.. code-block:: Python


    import matplotlib.pyplot as plt
    import numpy as np
    from PIL import Image as PILImage

    from aspire.denoising import DebugClassAvgSource, DefaultClassAvgSource
    from aspire.noise import WhiteNoiseAdder
    from aspire.source import ArrayImageSource  # Helpful hint if you want to BYO array.
    from aspire.utils import gaussian_2d








.. GENERATED FROM PYTHON SOURCE LINES 19-21

Build Simulated Data
--------------------

.. GENERATED FROM PYTHON SOURCE LINES 23-25

Circular 2D Gaussian Image
^^^^^^^^^^^^^^^^^^^^^^^^^^

.. GENERATED FROM PYTHON SOURCE LINES 25-31

.. code-block:: Python


    L = 100
    round_disc = gaussian_2d(L, sigma=L / 4)
    plt.imshow(round_disc, cmap="gray")
    plt.show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_001.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 32-34

Oval 2D Gaussian Image
^^^^^^^^^^^^^^^^^^^^^^

.. GENERATED FROM PYTHON SOURCE LINES 34-39

.. code-block:: Python


    oval_disc = gaussian_2d(L, sigma=(L / 20, L / 5))
    plt.imshow(oval_disc, cmap="gray")
    plt.show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_002.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_002.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 40-44

Handed Image
^^^^^^^^^^^^

Create richer test set by including an asymmetric image.

.. GENERATED FROM PYTHON SOURCE LINES 44-54

.. code-block:: Python


    # Create a second oval.
    oval_disc2 = gaussian_2d(L, mu=(L / 5, L / 6), sigma=(L / 15, L / 20))

    # Strategically add it to `oval_disc`.
    yoval_discL = oval_disc.copy()
    yoval_discL += oval_disc2
    plt.imshow(yoval_discL, cmap="gray")
    plt.show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_003.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_003.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 55-59

Reflected Image
^^^^^^^^^^^^^^^

Also include the reflection of  the asymmetric image.

.. GENERATED FROM PYTHON SOURCE LINES 59-64

.. code-block:: Python


    yoval_discR = np.flipud(yoval_discL)
    plt.imshow(yoval_discR, cmap="gray")
    plt.show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_004.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_004.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 65-70

Example Data Set Source
^^^^^^^^^^^^^^^^^^^^^^^

We concatenate and shuffle 512 rotations of the Gaussian images
above to create our data set.

.. GENERATED FROM PYTHON SOURCE LINES 70-99

.. code-block:: Python


    # How many entries (angles) in our stack
    N = 512
    thetas = np.linspace(start=0, stop=360, num=N, endpoint=False)

    classRound = np.zeros((N, L, L))
    classOval = np.zeros((N, L, L))
    classYOvalL = np.zeros((N, L, L))
    classYOvalR = np.zeros((N, L, L))

    for i, theta in enumerate(thetas):
        classRound[i] = np.asarray(PILImage.fromarray(round_disc).rotate(theta))
        classOval[i] = np.asarray(PILImage.fromarray(oval_disc).rotate(theta))
        classYOvalL[i] = np.asarray(PILImage.fromarray(yoval_discL).rotate(theta))
        classYOvalR[i] = np.asarray(PILImage.fromarray(yoval_discR).rotate(theta))

    # We'll make an example data set by concatentating then shuffling
    # these.
    example_array = np.concatenate((classRound, classOval, classYOvalL, classYOvalR))
    np.random.seed(1234567)
    np.random.shuffle(example_array)

    # So now that we have cooked up an example dataset, lets create an
    # ASPIRE source
    src = ArrayImageSource(example_array)

    # Let's peek at the images to make sure they're shuffled up nicely
    src.images[:10].show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_005.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_005.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 100-113

Basic Class Average
-------------------

This first example uses the ``DebugClassAvgSource`` to classify
images via the rotationally invariant representation
(``RIRClass2D``) algorithm.  ``DebugClassAvgSource`` internally uses
``TopClassSelector`` by default.  ``TopClassSelector``
deterministically selects the first ``n_classes``.
``DebugClassAvgSource`` also uses brute force rotational alignment
without shifts.  These simplifications are useful for development
and debugging.  Later we will discuss the more general
``ClassAvgSource`` and the modular components that are more suitable
to simulations and experimental datasets.

.. GENERATED FROM PYTHON SOURCE LINES 113-119

.. code-block:: Python


    avgs = DebugClassAvgSource(
        src=src,
        n_nbor=10,
    )








.. GENERATED FROM PYTHON SOURCE LINES 120-124

.. note:
    ``ClassAvgSource``s are lazily evaluated.
    They will generally compute the classifications, selections,
    and serve averaged results on request using the `.images[...]`.

.. GENERATED FROM PYTHON SOURCE LINES 127-130

Display Classes
^^^^^^^^^^^^^^^
Now we will request the first 10 images and display them.

.. GENERATED FROM PYTHON SOURCE LINES 130-133

.. code-block:: Python


    avgs.images[:10].show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_006.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_006.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/4 [00:00<?, ?it/s]    100%|██████████| 4/4 [00:00<00:00, 40.16it/s]
      0%|          | 0/4 [00:00<?, ?it/s]     25%|██▌       | 1/4 [00:00<00:00,  7.25it/s]     50%|█████     | 2/4 [00:00<00:00,  7.27it/s]     75%|███████▌  | 3/4 [00:00<00:00,  7.36it/s]    100%|██████████| 4/4 [00:00<00:00,  7.37it/s]    100%|██████████| 4/4 [00:00<00:00,  7.34it/s]
    Rotationally aligning classes:   0%|          | 0/10 [00:00<?, ?it/s]    Rotationally aligning classes:  10%|█         | 1/10 [00:00<00:01,  8.69it/s]    Rotationally aligning classes:  20%|██        | 2/10 [00:00<00:01,  6.93it/s]    Rotationally aligning classes:  40%|████      | 4/10 [00:00<00:00,  7.65it/s]    Rotationally aligning classes:  50%|█████     | 5/10 [00:00<00:00,  7.20it/s]    Rotationally aligning classes:  60%|██████    | 6/10 [00:00<00:00,  7.40it/s]    Rotationally aligning classes:  70%|███████   | 7/10 [00:00<00:00,  7.50it/s]    Rotationally aligning classes:  80%|████████  | 8/10 [00:01<00:00,  7.86it/s]    Rotationally aligning classes:  90%|█████████ | 9/10 [00:01<00:00,  7.87it/s]    Rotationally aligning classes: 100%|██████████| 10/10 [00:01<00:00,  8.24it/s]    Rotationally aligning classes: 100%|██████████| 10/10 [00:01<00:00,  7.78it/s]
    Stacking and evaluating class averages from FFBBasis2D to Cartesian:   0%|          | 0/1 [00:00<?, ?it/s]
    Stacking batch:   0%|          | 0/10 [00:00<?, ?it/s]
    Stacking batch:  20%|██        | 2/10 [00:00<00:00, 15.22it/s]
    Stacking batch:  70%|███████   | 7/10 [00:00<00:00, 30.41it/s]
                                                                      Stacking and evaluating class averages from FFBBasis2D to Cartesian: 100%|██████████| 1/1 [00:00<00:00,  2.94it/s]    Stacking and evaluating class averages from FFBBasis2D to Cartesian: 100%|██████████| 1/1 [00:00<00:00,  2.94it/s]




.. GENERATED FROM PYTHON SOURCE LINES 134-136

Class Averaging with Noise
--------------------------

.. GENERATED FROM PYTHON SOURCE LINES 138-140

Add Noise to Data Set
^^^^^^^^^^^^^^^^^^^^^

.. GENERATED FROM PYTHON SOURCE LINES 140-158

.. code-block:: Python


    # Using the sample variance, we'll compute a target noise variance
    # Noise
    var = np.var(src.images[:].asnumpy())
    noise_var = var * 2**4

    # Then create noise with the ``WhiteNoiseAdder`` class.
    noise = WhiteNoiseAdder(var=noise_var, seed=123)

    # Add noise to the images by performing ``forward``
    noisy_im = noise.forward(src.images[:])

    # Recast as an ASPIRE source
    noisy_src = ArrayImageSource(noisy_im)

    # Let's peek at the noisey images
    noisy_src.images[:10].show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_007.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_007.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 159-162

RIR with Noise
^^^^^^^^^^^^^^
Here we will use the noise_src.

.. GENERATED FROM PYTHON SOURCE LINES 162-168

.. code-block:: Python


    avgs = DebugClassAvgSource(
        src=noisy_src,
        n_nbor=10,
    )








.. GENERATED FROM PYTHON SOURCE LINES 169-177

Display Classes
^^^^^^^^^^^^^^^
Here, on request for images, the class average source will classify,
select, and average images.  All this occurs inside the
``ClassAvgSource`` components.  When using more advanced class
average sources, the images are remapped by the `selector`.  In this
case, using ``DebugClassAvgSource`` the first 10 images will simply
correspond to the first ten from ``noise_src``.

.. GENERATED FROM PYTHON SOURCE LINES 177-181

.. code-block:: Python


    avgs.images[:10].show()





.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_008.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_008.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/4 [00:00<?, ?it/s]    100%|██████████| 4/4 [00:00<00:00, 45.42it/s]
      0%|          | 0/4 [00:00<?, ?it/s]     50%|█████     | 2/4 [00:00<00:00, 11.04it/s]    100%|██████████| 4/4 [00:00<00:00, 11.31it/s]    100%|██████████| 4/4 [00:00<00:00, 11.26it/s]
    Rotationally aligning classes:   0%|          | 0/10 [00:00<?, ?it/s]    Rotationally aligning classes:  20%|██        | 2/10 [00:00<00:00,  9.42it/s]    Rotationally aligning classes:  30%|███       | 3/10 [00:00<00:00,  8.76it/s]    Rotationally aligning classes:  40%|████      | 4/10 [00:00<00:00,  8.47it/s]    Rotationally aligning classes:  50%|█████     | 5/10 [00:00<00:00,  8.01it/s]    Rotationally aligning classes:  60%|██████    | 6/10 [00:00<00:00,  8.24it/s]    Rotationally aligning classes:  80%|████████  | 8/10 [00:00<00:00,  8.69it/s]    Rotationally aligning classes:  90%|█████████ | 9/10 [00:01<00:00,  8.50it/s]    Rotationally aligning classes: 100%|██████████| 10/10 [00:01<00:00,  8.57it/s]    Rotationally aligning classes: 100%|██████████| 10/10 [00:01<00:00,  8.54it/s]
    Stacking and evaluating class averages from FFBBasis2D to Cartesian:   0%|          | 0/1 [00:00<?, ?it/s]
    Stacking batch:   0%|          | 0/10 [00:00<?, ?it/s]
    Stacking batch:  20%|██        | 2/10 [00:00<00:00, 15.58it/s]
    Stacking batch:  70%|███████   | 7/10 [00:00<00:00, 31.28it/s]
                                                                      Stacking and evaluating class averages from FFBBasis2D to Cartesian: 100%|██████████| 1/1 [00:00<00:00,  3.02it/s]    Stacking and evaluating class averages from FFBBasis2D to Cartesian: 100%|██████████| 1/1 [00:00<00:00,  3.02it/s]




.. GENERATED FROM PYTHON SOURCE LINES 182-186

Review a class
--------------

Select a class to review in the output.

.. GENERATED FROM PYTHON SOURCE LINES 186-202

.. code-block:: Python


    review_class = 5

    # Map this image from the sorted selection back to the input
    # ``noisy_src``.

    # Report the identified neighbor indices with respect to the input
    # ``noise_src``.
    classes = avgs.class_indices[review_class]
    reflections = avgs.class_refl[review_class]
    print(f"Class {review_class}'s neighbors: {classes}")
    print(f"Class {review_class}'s reflections: {reflections}")

    # The original image is the initial image in the class array.
    original_image_idx = classes[0]





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Class 5's neighbors: [   5 1746 1894 1954 1621 1218  313 1549 1137 1685]
    Class 5's reflections: [False  True  True False False  True False False False  True]




.. GENERATED FROM PYTHON SOURCE LINES 203-204

Report the identified neighbors, original is the first image.

.. GENERATED FROM PYTHON SOURCE LINES 204-207

.. code-block:: Python


    noisy_src.images[classes].show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_009.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_009.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 208-209

Display original image.

.. GENERATED FROM PYTHON SOURCE LINES 209-212

.. code-block:: Python


    noisy_src.images[original_image_idx].show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_010.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_010.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 213-214

Display the averaged result

.. GENERATED FROM PYTHON SOURCE LINES 214-216

.. code-block:: Python

    avgs.images[review_class].show()




.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_011.png
   :alt: class averaging
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_011.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Rotationally aligning classes:   0%|          | 0/1 [00:00<?, ?it/s]    Rotationally aligning classes: 100%|██████████| 1/1 [00:00<00:00, 10.56it/s]
    Stacking and evaluating class averages from FFBBasis2D to Cartesian:   0%|          | 0/1 [00:00<?, ?it/s]
    Stacking batch:   0%|          | 0/1 [00:00<?, ?it/s]
                                                             Stacking and evaluating class averages from FFBBasis2D to Cartesian: 100%|██████████| 1/1 [00:00<00:00,  8.57it/s]    Stacking and evaluating class averages from FFBBasis2D to Cartesian: 100%|██████████| 1/1 [00:00<00:00,  8.56it/s]




.. GENERATED FROM PYTHON SOURCE LINES 217-223

Alignment Details
^^^^^^^^^^^^^^^^^

Alignment details are exposed when available from an underlying
``averager``.  In this case, we'll get the estimated alignments for
the ``review_class``.

.. GENERATED FROM PYTHON SOURCE LINES 223-269

.. code-block:: Python



    est_rotations = avgs.averager.rotations
    est_shifts = avgs.averager.shifts
    est_dot_products = avgs.averager.dot_products

    print(f"Estimated Rotations: {est_rotations}")
    print(f"Estimated Shifts: {est_shifts}")
    print(f"Estimated Dot Products: {est_dot_products}")

    # Compare the original unaligned images with the estimated alignment.
    # Get the indices from the classification results.
    nbr = 3
    original_img_0_idx = classes[0]
    original_img_nbr_idx = classes[nbr]

    # Lookup the images.
    original_img_0 = noisy_src.images[original_img_0_idx].asnumpy()[0]
    original_img_nbr = noisy_src.images[original_img_nbr_idx].asnumpy()[0]

    # Rotate using estimated rotations.
    angle = est_rotations[0, nbr] * 180 / np.pi
    if reflections[nbr]:
        print("Reflection reported.")
        original_img_nbr = np.flipud(original_img_nbr)
    rotated_img_nbr = np.asarray(PILImage.fromarray(original_img_nbr).rotate(angle))

    plt.subplot(2, 2, 1)
    plt.title("Original Images")
    plt.imshow(original_img_0)
    plt.xlabel("Img 0")
    plt.subplot(2, 2, 2)
    plt.imshow(original_img_nbr)
    plt.xlabel(f"Img {nbr}")

    plt.subplot(2, 2, 3)
    plt.title("Est Rotation Applied")
    plt.imshow(original_img_0)
    plt.xlabel("Img 0")
    plt.subplot(2, 2, 4)
    plt.imshow(rotated_img_nbr)
    plt.xlabel(f"Img {nbr} rotated {angle:.4}*")
    plt.tight_layout()
    plt.show()





.. image-sg:: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_012.png
   :alt: Original Images, Est Rotation Applied
   :srcset: /auto_tutorials/tutorials/images/sphx_glr_class_averaging_012.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Estimated Rotations: [[-0.         -1.09955743 -4.9043752  -0.89011792 -1.97222205 -1.11701072
      -5.41052068 -5.68977336 -0.80285146 -2.0943951 ]]
    Estimated Shifts: None
    Estimated Dot Products: [[5852.89921803  573.28999826  479.46088919  590.9274435   594.50869367
       519.78865321  587.87430859  578.70368405  532.22253236  602.78321579]]




.. GENERATED FROM PYTHON SOURCE LINES 270-282

ClassAvgSource Components
-------------------------
For more realistic simulations and experimental data,
ASPIRE provides a wholly customizable base ``ClassAvgSource``
class. This class expects a user to instantiate and provide
all components required for class averaging.

To make things easier a practical starting point
``DefaultClassAvgSource`` is provided which fills in reasonable
defaults based on what is available in the current ASPIRE-Python.
The defaults can be overridden simply by instantiating your own
instances of components and passing during initialization.

.. GENERATED FROM PYTHON SOURCE LINES 282-288

.. code-block:: Python


    # Using the defaults requires only passing a source.
    # After understanding the various components that can be
    # combined in a ``ClassAvgSource``, they can be customized
    # or easily extended.
    avg_src = DefaultClassAvgSource(noisy_src)








.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 41.513 seconds)


.. _sphx_glr_download_auto_tutorials_tutorials_class_averaging.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: class_averaging.ipynb <class_averaging.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: class_averaging.py <class_averaging.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: class_averaging.zip <class_averaging.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
