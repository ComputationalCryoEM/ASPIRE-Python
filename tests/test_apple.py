import os
import tempfile
from shutil import copyfile
from unittest import TestCase

import mrcfile

import tests.saved_test_data
from aspire.apple.apple import Apple
from aspire.utils import importlib_path


class ApplePickerTestCase(TestCase):
    def setUp(self):
        pass

    def tearDown(self):
        pass

    def testPickCenters(self):
        # 461 particles with the following centers
        centers = {
            (149, 621),
            (153, 735),
            (155, 1079),
            (157, 1299),
            (159, 981),
            (159, 1687),
            (215, 2717),
            (223, 2181),
            (223, 3245),
            (239, 733),
            (247, 321),
            (249, 183),
            (253, 2601),
            (255, 1925),
            (257, 1369),
            (269, 2219),
            (277, 2219),
            (279, 3079),
            (289, 2219),
            (293, 1457),
            (305, 883),
            (317, 2473),
            (325, 1719),
            (325, 3677),
            (341, 3379),
            (347, 1251),
            (355, 1119),
            (355, 1885),
            (355, 3621),
            (371, 955),
            (379, 3471),
            (387, 2931),
            (389, 1579),
            (391, 367),
            (393, 2591),
            (405, 767),
            (437, 2427),
            (437, 3097),
            (445, 2005),
            (455, 257),
            (461, 715),
            (465, 687),
            (475, 1131),
            (483, 2887),
            (485, 1129),
            (487, 1459),
            (501, 3301),
            (505, 3613),
            (523, 1959),
            (531, 2607),
            (531, 3151),
            (535, 1289),
            (535, 2889),
            (543, 617),
            (547, 1041),
            (547, 2053),
            (547, 2425),
            (555, 225),
            (581, 3557),
            (599, 2943),
            (605, 1439),
            (669, 2389),
            (685, 3591),
            (687, 2537),
            (689, 2529),
            (691, 3101),
            (693, 739),
            (697, 2631),
            (699, 3609),
            (715, 189),
            (715, 3201),
            (719, 3071),
            (725, 3491),
            (727, 1189),
            (747, 581),
            (747, 2475),
            (747, 3297),
            (755, 1773),
            (781, 3775),
            (785, 511),
            (787, 1589),
            (809, 2031),
            (813, 2617),
            (817, 2329),
            (821, 3009),
            (827, 3401),
            (839, 2985),
            (849, 1273),
            (851, 2877),
            (853, 3079),
            (861, 1839),
            (861, 1947),
            (861, 3253),
            (873, 377),
            (873, 1201),
            (883, 2015),
            (889, 671),
            (895, 2643),
            (907, 2831),
            (913, 1851),
            (925, 3507),
            (927, 1417),
            (939, 331),
            (939, 1849),
            (945, 1395),
            (955, 3061),
            (961, 887),
            (965, 2305),
            (983, 1751),
            (983, 1863),
            (987, 1829),
            (991, 1535),
            (993, 3197),
            (1009, 1659),
            (1017, 2363),
            (1023, 1075),
            (1023, 3623),
            (1025, 209),
            (1077, 3315),
            (1087, 2763),
            (1087, 3501),
            (1111, 2497),
            (1115, 1607),
            (1115, 1687),
            (1127, 3697),
            (1139, 931),
            (1143, 2515),
            (1165, 1001),
            (1169, 843),
            (1169, 3799),
            (1187, 3457),
            (1191, 3375),
            (1195, 653),
            (1207, 779),
            (1217, 3149),
            (1225, 2519),
            (1233, 941),
            (1233, 2137),
            (1237, 1571),
            (1237, 3297),
            (1243, 1977),
            (1245, 2381),
            (1249, 451),
            (1249, 2823),
            (1249, 3039),
            (1257, 2275),
            (1263, 149),
            (1269, 1335),
            (1287, 221),
            (1321, 361),
            (1331, 1689),
            (1345, 3311),
            (1359, 2351),
            (1361, 1519),
            (1363, 1111),
            (1365, 2551),
            (1369, 2847),
            (1371, 3055),
            (1379, 811),
            (1387, 1965),
            (1423, 613),
            (1441, 985),
            (1443, 1491),
            (1447, 2203),
            (1455, 223),
            (1463, 1139),
            (1475, 1555),
            (1475, 2911),
            (1481, 1365),
            (1481, 3091),
            (1495, 2737),
            (1495, 3309),
            (1507, 531),
            (1509, 847),
            (1509, 3785),
            (1511, 1721),
            (1523, 737),
            (1529, 2387),
            (1535, 2853),
            (1547, 1649),
            (1549, 1957),
            (1577, 3575),
            (1583, 2975),
            (1585, 929),
            (1647, 273),
            (1651, 1545),
            (1651, 2457),
            (1655, 2393),
            (1657, 2433),
            (1667, 2005),
            (1685, 1559),
            (1687, 735),
            (1691, 817),
            (1693, 1253),
            (1693, 3437),
            (1703, 887),
            (1705, 3403),
            (1711, 365),
            (1715, 167),
            (1733, 3779),
            (1737, 3193),
            (1739, 2759),
            (1741, 377),
            (1741, 1391),
            (1767, 2507),
            (1771, 2633),
            (1795, 679),
            (1795, 1287),
            (1805, 3423),
            (1811, 2281),
            (1815, 2793),
            (1817, 299),
            (1821, 865),
            (1863, 2645),
            (1869, 3385),
            (1871, 275),
            (1887, 2597),
            (1897, 3381),
            (1905, 861),
            (1905, 1029),
            (1907, 1305),
            (1911, 1939),
            (1917, 3527),
            (1919, 2825),
            (1941, 3297),
            (1943, 3053),
            (1951, 1553),
            (1955, 367),
            (1955, 1823),
            (1961, 2677),
            (1965, 2397),
            (1967, 3533),
            (1987, 1693),
            (1989, 919),
            (1997, 2605),
            (2011, 3561),
            (2021, 2833),
            (2025, 1167),
            (2037, 3281),
            (2037, 3705),
            (2047, 3001),
            (2049, 783),
            (2055, 2997),
            (2055, 3857),
            (2081, 667),
            (2099, 963),
            (2117, 1079),
            (2131, 3587),
            (2141, 2489),
            (2151, 2741),
            (2163, 3247),
            (2167, 247),
            (2177, 821),
            (2179, 3037),
            (2187, 1339),
            (2201, 731),
            (2215, 2211),
            (2219, 2221),
            (2243, 2257),
            (2243, 2467),
            (2245, 2329),
            (2269, 1329),
            (2273, 935),
            (2281, 1541),
            (2287, 3335),
            (2297, 3053),
            (2297, 3167),
            (2303, 261),
            (2317, 2215),
            (2327, 3475),
            (2331, 3085),
            (2337, 759),
            (2359, 1859),
            (2359, 2873),
            (2381, 2681),
            (2383, 1425),
            (2389, 3125),
            (2389, 3509),
            (2401, 873),
            (2403, 3621),
            (2411, 507),
            (2415, 2563),
            (2453, 307),
            (2461, 1439),
            (2469, 3051),
            (2473, 909),
            (2477, 635),
            (2481, 617),
            (2487, 1875),
            (2501, 3493),
            (2505, 2477),
            (2507, 2619),
            (2517, 1975),
            (2527, 1489),
            (2527, 1999),
            (2535, 201),
            (2547, 1275),
            (2563, 3043),
            (2581, 3575),
            (2587, 1871),
            (2601, 2595),
            (2621, 1065),
            (2625, 487),
            (2625, 1909),
            (2627, 2561),
            (2633, 489),
            (2635, 173),
            (2647, 491),
            (2649, 1427),
            (2655, 2045),
            (2657, 3849),
            (2659, 1601),
            (2659, 3721),
            (2681, 2751),
            (2687, 649),
            (2693, 2587),
            (2697, 667),
            (2697, 1629),
            (2701, 3553),
            (2703, 1737),
            (2709, 2367),
            (2723, 1181),
            (2727, 3333),
            (2747, 2823),
            (2757, 1453),
            (2765, 1729),
            (2769, 2719),
            (2769, 3405),
            (2779, 3061),
            (2789, 2779),
            (2791, 693),
            (2793, 1239),
            (2797, 3701),
            (2825, 1903),
            (2829, 2011),
            (2829, 3753),
            (2835, 2219),
            (2851, 3883),
            (2879, 433),
            (2899, 1081),
            (2921, 2257),
            (2937, 869),
            (2937, 2589),
            (2957, 1267),
            (2969, 643),
            (2971, 3091),
            (2975, 963),
            (2979, 2255),
            (2979, 3153),
            (2995, 3771),
            (3007, 3499),
            (3029, 1607),
            (3037, 1089),
            (3055, 239),
            (3061, 3739),
            (3075, 1807),
            (3075, 2871),
            (3079, 3441),
            (3083, 1461),
            (3087, 503),
            (3091, 2327),
            (3109, 3341),
            (3113, 687),
            (3121, 1267),
            (3125, 849),
            (3129, 285),
            (3131, 353),
            (3131, 2943),
            (3159, 1395),
            (3159, 3763),
            (3171, 1071),
            (3185, 627),
            (3185, 2113),
            (3199, 959),
            (3211, 405),
            (3213, 1459),
            (3219, 709),
            (3223, 3295),
            (3229, 539),
            (3241, 1141),
            (3247, 1889),
            (3251, 2703),
            (3267, 1237),
            (3271, 2591),
            (3275, 3685),
            (3287, 1679),
            (3287, 2099),
            (3319, 547),
            (3319, 2831),
            (3331, 3487),
            (3337, 3315),
            (3339, 2601),
            (3351, 3393),
            (3363, 2387),
            (3365, 1755),
            (3365, 3465),
            (3367, 2281),
            (3375, 403),
            (3379, 2535),
            (3389, 721),
            (3399, 2145),
            (3413, 1841),
            (3433, 1069),
            (3437, 3577),
            (3439, 2685),
            (3441, 1535),
            (3453, 589),
            (3453, 597),
            (3463, 821),
            (3469, 1497),
            (3473, 705),
            (3475, 1987),
            (3475, 2509),
            (3483, 1849),
            (3487, 1455),
            (3491, 2185),
            (3509, 2905),
            (3529, 2845),
            (3539, 2295),
            (3559, 1235),
            (3559, 1581),
            (3565, 3643),
            (3571, 1457),
            (3573, 861),
            (3575, 2453),
            (3579, 2737),
            (3581, 1727),
            (3581, 2115),
            (3583, 993),
            (3591, 3535),
            (3593, 3653),
            (3613, 2047),
            (3653, 2847),
            (3657, 2239),
            (3675, 1339),
            (3677, 1031),
            (3695, 1231),
            (3695, 1639),
            (3705, 2995),
            (3729, 1467),
            (3735, 2253),
            (3737, 3399),
            (3761, 3403),
            (3763, 3583),
            (3781, 2341),
            (3783, 3089),
            (3807, 1191),
            (3807, 1547),
            (3819, 3711),
            (3831, 2805),
            (3843, 1427),
            (3851, 1963),
            (3877, 3063),
            (3897, 1647),
            (3901, 3227),
            (3907, 1487),
            (3909, 2349),
            (3919, 2635),
            (3921, 2415),
            (3933, 2957),
            (3943, 3579),
        }

        with tempfile.TemporaryDirectory() as tmpdir_name:
            apple_picker = Apple(
                particle_size=78,
                min_particle_size=19,
                max_particle_size=156,
                minimum_overlap_amount=7,
                tau1=710,
                tau2=7100,
                output_dir=tmpdir_name,
            )
            with importlib_path(tests.saved_test_data, "sample.mrc") as mrc_path:
                centers_found = apple_picker.process_micrograph_centers(mrc_path)
                for center_found in centers_found:
                    _x, _y = tuple(center_found)
                    if (_x, _y) not in centers:
                        self.fail("({}, {}) not an expected center.".format(_x, _y))
                    else:
                        centers.remove((_x, _y))

                if centers:
                    self.fail("Not all expected centers were found!")

    def testFileCorruption(self):
        """
        Test that corrupt mrcfiles are logged as expected.
        """

        # Create a tmp dir for this test output
        with tempfile.TemporaryDirectory() as tmpdir_name:
            # Instantiate an Apple instance
            apple_picker = Apple(particle_size=42, output_dir=tmpdir_name)

            # Get the path of an input mrcfile
            with importlib_path(tests.saved_test_data, "sample.mrc") as good_mrc_path:
                # Store bad mrc in tmp test dir so it gets cleaned up
                bad_mrc_path = os.path.join(tmpdir_name, "bad.mrc")

                # Copy mrc file
                copyfile(good_mrc_path, bad_mrc_path)

            # Open mrc file and soft corrupt it
            with mrcfile.open(bad_mrc_path, "r+") as fh:
                fh.header.map = -1

            # Check that we get a WARNING
            with self.assertLogs(level="WARNING") as logs:
                _ = apple_picker.process_micrograph_centers(bad_mrc_path)

            # Check the message prefix
            self.assertTrue(
                "APPLE.picking mrcfile reporting 1 corruptions" in logs.output[0]
            )

            # Check the message contains the file path
            self.assertTrue(bad_mrc_path in logs.output[0])

    def testEmptyCenters(self):
        """
        Test we handle case were no centers are found.
        """
        with tempfile.TemporaryDirectory() as tmpdir_name:
            apple_picker = Apple(
                particle_size=78,
                min_particle_size=90,
                max_particle_size=90,
                output_dir=tmpdir_name,
            )

            with importlib_path(tests.saved_test_data, "sample.mrc") as mrc_path:
                centers_found = apple_picker.process_micrograph_centers(mrc_path)

        self.assertTrue(len(centers_found) == 0)
